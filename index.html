<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedWeb — Billing Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#08080d;--surface:#0f0f18;--surface2:#16162a;
  --gold:#d4a574;--green:#7ecba1;--orange:#e8a87c;
  --text:#e4e4e7;--text2:#9a9ab0;--border:#1e1e35;
  --radius:12px;
}
html{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;height:100%}
body{height:100%;display:flex;justify-content:center}
.mono{font-family:'JetBrains Mono',monospace}

/* LOGIN */
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;width:100%}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:48px 40px;text-align:center;max-width:400px;width:100%}
.login-card h1{font-size:1.6rem;font-weight:700;margin-bottom:8px;color:var(--gold)}
.login-card p{color:var(--text2);margin-bottom:32px;font-size:.95rem}
.login-card .logo{font-size:2.4rem;margin-bottom:16px}
.btn-github{display:inline-flex;align-items:center;gap:10px;background:#24292e;color:#fff;border:none;padding:12px 28px;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;text-decoration:none;transition:background .2s}
.btn-github:hover{background:#3a3f44}
.btn-github svg{width:20px;height:20px;fill:#fff}
.error-banner{background:#7f1d1d88;border:1px solid #ef4444;color:#fca5a5;padding:10px 14px;border-radius:8px;margin-bottom:20px;font-size:.85rem}
.warn-banner{background:#78350f66;border:1px solid #f59e0b;color:#fcd34d;padding:10px 14px;border-radius:8px;margin-bottom:14px;font-size:.82rem;text-align:center}

/* LAYOUT */
.app{width:100%;max-width:960px;padding:24px 32px 20px;display:flex;flex-direction:column;height:100vh}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:8px}
.header-left{display:flex;align-items:center;gap:14px}
.header h1{font-size:1.2rem;font-weight:700;color:var(--gold)}
.user-info{display:flex;align-items:center;gap:10px}
.user-info img{width:28px;height:28px;border-radius:50%;border:2px solid var(--border)}
.user-info span{font-size:.82rem;color:var(--text2)}
.btn-logout,.btn-refresh{background:var(--surface2);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:6px;font-size:.75rem;cursor:pointer;font-family:inherit;transition:border-color .2s,color .2s}
.btn-logout:hover,.btn-refresh:hover{border-color:var(--gold);color:var(--text)}
.refresh-ts{font-size:.7rem;color:var(--text2)}

/* CARDS */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.card{background:linear-gradient(135deg,var(--surface),var(--surface2));border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px}
.card-label{font-size:.68rem;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.card-value{font-size:1.25rem;font-weight:600}
.card-sub{font-size:.68rem;color:var(--text2);margin-top:2px}
.badge{display:inline-block;padding:1px 8px;border-radius:20px;font-size:.68rem;font-weight:600}
.badge-green{background:#065f4622;color:var(--green);border:1px solid #065f4655}
.badge-orange{background:#7c2d1222;color:var(--orange);border:1px solid #7c2d1255}

/* TABLE with inline bars */
.section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;flex:1;min-height:0;display:flex;flex-direction:column}
.section-title{font-size:.88rem;font-weight:600;margin-bottom:10px;color:var(--text)}
.table-wrap{overflow-x:auto;flex:1}
table{width:100%;border-collapse:collapse;font-size:.82rem}
th{text-align:left;color:var(--text2);font-weight:500;padding:7px 10px;border-bottom:1px solid var(--border);font-size:.68rem;text-transform:uppercase;letter-spacing:.4px}
td{padding:7px 10px;border-bottom:1px solid var(--border)22}
tr:last-child td{border-bottom:none}
tr.total-row{background:var(--surface2);font-weight:700}
tr.total-row td{border-top:2px solid var(--gold);color:var(--gold)}
.text-right{text-align:right}
.item-cell{display:flex;align-items:center;gap:10px}
.item-name{flex-shrink:0}
.item-bar{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;min-width:40px}
.item-bar-fill{height:100%;border-radius:3px}
.item-pct{font-size:.68rem;color:var(--text2);flex-shrink:0;width:36px;text-align:right}

/* FOOTER */
.footer{margin-top:12px;padding:8px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);font-size:.68rem;color:var(--text2);display:flex;flex-wrap:wrap;gap:2px 16px}

/* SPINNER */
.spinner-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:16px;width:100%}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner-text{color:var(--text2);font-size:.9rem}

/* 2K */
@media(min-width:1600px){
  .app{max-width:1200px;padding:32px 48px 24px}
  .header h1{font-size:1.4rem}
  .cards{gap:14px;margin-bottom:20px}
  .card{padding:18px 20px}
  .card-label{font-size:.74rem}
  .card-value{font-size:1.5rem}
  .section{padding:20px 24px}
  .section-title{font-size:1rem}
  table{font-size:.9rem}
  th{padding:9px 14px;font-size:.72rem}
  td{padding:9px 14px}
  .item-bar{height:8px}
  .footer{font-size:.74rem;padding:10px 20px}
}
/* 4K */
@media(min-width:2200px){
  .app{max-width:1600px;padding:48px 72px 32px}
  .header h1{font-size:1.7rem}
  .user-info img{width:36px;height:36px}
  .user-info span{font-size:.95rem}
  .btn-logout,.btn-refresh{padding:6px 14px;font-size:.82rem}
  .cards{gap:18px;margin-bottom:24px}
  .card{padding:22px 24px;border-radius:16px}
  .card-label{font-size:.82rem;margin-bottom:6px}
  .card-value{font-size:1.8rem}
  .card-sub{font-size:.78rem}
  .section{padding:24px 28px;border-radius:16px}
  .section-title{font-size:1.15rem;margin-bottom:14px}
  table{font-size:1rem}
  th{padding:12px 18px;font-size:.78rem}
  td{padding:12px 18px}
  .item-bar{height:10px;border-radius:5px}
  .item-pct{font-size:.78rem;width:42px}
  .footer{font-size:.82rem;padding:12px 24px;border-radius:16px}
  .refresh-ts{font-size:.78rem}
}
/* Mobile */
@media(max-width:700px){
  .app{padding:14px 12px 16px;height:auto;min-height:100vh}
  .cards{grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
  .card{padding:10px 12px}
  .card-value{font-size:1.05rem}
  .item-cell{gap:6px}
  .item-bar{min-width:20px}
  th,td{padding:6px 6px;font-size:.75rem}
}
@media(max-width:440px){
  .header{flex-direction:column;align-items:flex-start}
  .cards{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div id="login-screen" class="login-screen" style="display:none">
  <div class="login-card">
    <div class="logo">&#9764;&#65039;</div>
    <h1>MedWeb Billing</h1>
    <p>Painel de custos do projeto MedWeb.<br>Faça login com sua conta GitHub autorizada.</p>
    <div id="login-error" class="error-banner" style="display:none"></div>
    <a href="/api/auth/login" class="btn-github">
      <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      Entrar com GitHub
    </a>
  </div>
</div>

<div id="loading-screen" class="spinner-wrap" style="display:none">
  <div class="spinner"></div>
  <div class="spinner-text">Carregando dados de billing...</div>
</div>

<div id="dashboard" class="app" style="display:none">
  <div class="header">
    <div class="header-left">
      <h1>&#9764;&#65039; MedWeb Billing</h1>
      <button class="btn-refresh" onclick="loadCosts()">&#8635; Atualizar</button>
      <span id="refresh-ts" class="refresh-ts"></span>
    </div>
    <div class="user-info">
      <img id="user-avatar" src="" alt="">
      <span id="user-name"></span>
      <a href="/api/auth/logout" class="btn-logout">Sair</a>
    </div>
  </div>

  <div id="api-warn" class="warn-banner" style="display:none">&#9888;&#65039; Não foi possível conectar ao servidor. Exibindo dados estimados.</div>

  <div class="cards" id="cards"></div>

  <div class="section">
    <div class="section-title">Detalhamento dos Custos</div>
    <div class="table-wrap"><table id="detail-table"></table></div>
  </div>

  <div class="footer" id="footer"></div>
</div>

<script>
const ERROR_MSGS = {
  unauthorized: 'Acesso negado. Sua conta GitHub não está autorizada.',
  token_failed: 'Falha ao obter token de autenticação. Tente novamente.',
  server_error: 'Erro interno do servidor. Tente novamente mais tarde.',
  no_code: 'Código de autorização não recebido. Tente novamente.'
};

const CATEGORY_COLORS = {
  claude_ai: '#a78bfa',
  lovable_pro: '#f472b6',
  vercel_pro: '#38bdf8',
  apple_developer: '#60a5fa'
};

const FALLBACK_DATA = {
  period: { start: '2025-05-01', end: new Date().toISOString().split('T')[0] },
  exchange: { usd_brl: 5.80, iof_rate: 0.035 },
  items: [
    { id: 'claude_ai', label: 'Claude.ai (mai/2025)', usd: 94.83, brl: 550, iof: 0, total_brl: 550 },
    { id: 'claude_ai', label: 'Claude.ai (jan/2026)', usd: 189.66, brl: 1100, iof: 0, total_brl: 1100 },
    { id: 'claude_ai', label: 'Claude.ai (fev/2026)', usd: 14.11, brl: 81.84, iof: 0, total_brl: 81.84 },
    { id: 'claude_ai', label: 'Claude.ai Uso Extra', usd: 47.41, brl: 275, iof: 0, total_brl: 275 },
    { id: 'lovable_pro', label: 'Lovable Pro (5 meses)', usd: 125, brl: 725, iof: 25.38, total_brl: 750.38 },
    { id: 'vercel_pro', label: 'Vercel Pro (5 meses)', usd: 100, brl: 580, iof: 20.3, total_brl: 600.3 },
    { id: 'apple_developer', label: 'Apple Developer (anual)', usd: 99, brl: 574.2, iof: 20.1, total_brl: 594.3 }
  ],
  totals: { usd: 670.01, brl: 3956.52, iof: 65.78, budget_brl: 536500, budget_pct: 0.74 },
  fetched_at: new Date().toISOString(),
  _fallback: true
};

let currentUser = null;

function fmt(n) { return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function show(id) { document.getElementById(id).style.display = ''; }
function hide(id) { document.getElementById(id).style.display = 'none'; }

async function init() {
  const params = new URLSearchParams(window.location.search);
  const err = params.get('error');
  if (err) window.history.replaceState({}, '', '/');
  try {
    const res = await fetch('/api/auth/me');
    const data = await res.json();
    if (data.authenticated) { currentUser = data.user; showDashboard(err); return; }
  } catch (e) {}
  showLogin(err);
}

function showLogin(err) {
  hide('loading-screen'); hide('dashboard'); show('login-screen');
  if (err && ERROR_MSGS[err]) {
    const el = document.getElementById('login-error');
    el.textContent = ERROR_MSGS[err]; el.style.display = '';
  }
}

async function showDashboard(err) {
  hide('login-screen'); show('loading-screen');
  document.getElementById('user-avatar').src = currentUser.avatar || currentUser.avatar_url || '';
  document.getElementById('user-name').textContent = currentUser.name || currentUser.login;
  await loadCosts();
  hide('loading-screen'); show('dashboard');
}

async function loadCosts() {
  let data, isFallback = false;
  try {
    const res = await fetch('/api/costs');
    if (!res.ok) throw new Error();
    data = await res.json();
  } catch (e) { data = FALLBACK_DATA; isFallback = true; }

  document.getElementById('api-warn').style.display = isFallback ? '' : 'none';
  renderCards(data);
  renderTable(data);
  renderFooter(data);
  document.getElementById('refresh-ts').textContent = new Date(data.fetched_at || Date.now()).toLocaleString('pt-BR');
}

function renderCards(data) {
  const t = data.totals, ex = data.exchange;
  const totalIof = t.iof || data.items.reduce((s, c) => s + c.iof, 0);
  const pctClass = t.budget_pct < 10 ? 'badge-green' : 'badge-orange';
  document.getElementById('cards').innerHTML = `
    <div class="card">
      <div class="card-label">Total Investido</div>
      <div class="card-value mono" style="color:var(--gold)">R$ ${fmt(t.brl)}</div>
      <div class="card-sub"><span class="badge ${pctClass}">${fmt(t.budget_pct)}% do orçamento</span></div>
    </div>
    <div class="card">
      <div class="card-label">Orçamento</div>
      <div class="card-value mono">R$ ${fmt(t.budget_brl)}</div>
      <div class="card-sub">Projeto MedWeb</div>
    </div>
    <div class="card">
      <div class="card-label">Câmbio USD → BRL</div>
      <div class="card-value mono" style="color:var(--green)">R$ ${fmt(ex.usd_brl)}</div>
      <div class="card-sub">Referência</div>
    </div>
    <div class="card">
      <div class="card-label">IOF Total</div>
      <div class="card-value mono" style="color:var(--orange)">R$ ${fmt(totalIof)}</div>
      <div class="card-sub">${(ex.iof_rate * 100).toFixed(1)}% compras USD</div>
    </div>`;
}

function renderTable(data) {
  const rows = data.items.map(c => ({ id: c.id, label: c.label, usd: c.usd, brl: c.brl, iof: c.iof, total: c.total_brl }));
  const grand = rows.reduce((s, r) => s + r.total, 0);
  const maxTotal = Math.max(...rows.map(r => r.total));
  const sumUsd = rows.reduce((s, r) => s + r.usd, 0);
  const sumBrl = rows.reduce((s, r) => s + r.brl, 0);
  const sumIof = rows.reduce((s, r) => s + r.iof, 0);

  document.getElementById('detail-table').innerHTML = `
    <thead><tr>
      <th style="width:40%">Item</th>
      <th class="text-right">USD</th>
      <th class="text-right">BRL</th>
      <th class="text-right">IOF</th>
      <th class="text-right">Total (R$)</th>
    </tr></thead>
    <tbody>
      ${rows.map(r => {
        const pct = (r.total / grand * 100).toFixed(1);
        const w = (r.total / maxTotal * 100);
        const color = CATEGORY_COLORS[r.id] || '#888';
        return `<tr>
          <td><div class="item-cell">
            <span class="item-name">${r.label}</span>
            <div class="item-bar"><div class="item-bar-fill" style="width:${w}%;background:${color}"></div></div>
            <span class="item-pct">${pct}%</span>
          </div></td>
          <td class="text-right mono">$ ${fmt(r.usd)}</td>
          <td class="text-right mono">R$ ${fmt(r.brl)}</td>
          <td class="text-right mono">R$ ${fmt(r.iof)}</td>
          <td class="text-right mono">R$ ${fmt(r.total)}</td>
        </tr>`;
      }).join('')}
      <tr class="total-row">
        <td>Total</td>
        <td class="text-right mono">$ ${fmt(sumUsd)}</td>
        <td class="text-right mono">R$ ${fmt(sumBrl)}</td>
        <td class="text-right mono">R$ ${fmt(sumIof)}</td>
        <td class="text-right mono">R$ ${fmt(grand)}</td>
      </tr>
    </tbody>`;
}

function renderFooter(data) {
  const p = data.period;
  document.getElementById('footer').innerHTML = `
    <span>Claude.ai: faturas reais em BRL</span>
    <span>Lovable/Vercel/Apple: USD + IOF ${(data.exchange.iof_rate * 100).toFixed(1)}%</span>
    <span>Câmbio ref: R$ ${fmt(data.exchange.usd_brl)}</span>
    <span>Período: ${new Date(p.start).toLocaleDateString('pt-BR')} — ${new Date(p.end).toLocaleDateString('pt-BR')}</span>`;
}

init();
</script>
</body>
</html>
